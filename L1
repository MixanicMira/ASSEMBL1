# ASSEMBLER
;
; L1ELECTR.asm
;
; Created: 26.09.2017 18:43:22
; Author : MixanicMira
 
 ;***** 01_AVR_L.asm (Управление светодиодами)
.include "2313def.inc"
.device ATtiny2313
.def Temp =r16 ;рабочий регистр
.def Delay1=r17 ;регистры для хранения задержек
.def Delay2=r18
.def Delay3=r19
.equ TDelay=300
;*****    Инициализация (настройка оборудования)
INIT:
     ser Temp ;установка всех бит регистра в единицу
     out DDRB,Temp ;PORTB ориентирован на вывод
     com Temp ;побитная инверсия
;===============================================
;вывод на индикацию буфера отображения Temp
loop:
     clr Temp ;Очистить регистр (операция"исключающее ИЛИ" регистра с самим собой)
     lsr Temp ;Логический сдвиг вправо (с установкой переноса)
     adc Temp, r18 ;Сложение двух регистров общего назначения с учетом переноса
     out PORTB, Temp ;вывод данных в  PORTB
;===============================================
;**** Задержка перед очередной визуализацией.
;Состоит из трёх вложенных друг в друга циклов.
;Общее время задержки определяется выражением:
;Tdelay=((5xDelay1+5)xDelay2)+5)Delay3=(((5x210+5)x250)+5)4=1060000 тактов
;где 5  - количество тактов МК при выполнении команд входящих в тело цикла
DLY3:
     ldi Delay3,1 ;число повторов внешнего цикла
DLY2:
     ldi Delay2,1 ;число повторов среднего цикла
DLY1:
     ldi Delay1,1 ;число повторов внутреннего цикла
DLY:
;Внутренний цикл задержки повторяется Delay1 раз расходуя 5 тактов на каждое повторение
     dec Delay1;уменьшение счётчика внутреннего цикла
     nop ;две пустые команды увеличивают время
     nop ;выполнения внутреннего цикла
     brne DLY ;повторять до обнуления счётчика
;Средний цикл выполняется один раз, контролирует свой счётчик.
;если не обнулён, то перезагружает счётчик внутреннего цикла и запускает внутренний цикл на повторное исполнение.
     dec Delay2;уменьшение счётчика на единицу
     nop
     nop
brne DLY1 ;на перезагрузку и повтор внутреннего цикла
;Внешний цикл повторно вызывает вложенный в него средний цикл до
;обнуления собственного счётчика. При его обнулении задержка завершается.
    dec Delay3 ;уменьшение на единицу счётчика внешнего цикла
    nop
    nop
brne DLY2 ;переход на перезагрузку и повтор среднего цикла
;===============================================
  rjmp loop ;повторный цикл визуализации по завершении задержки
